<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDB Downloader</title>

  <!-- 引入打包 ZIP 所需库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #eef5f9; margin: 0; padding: 40px 16px; color: #333; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 30px 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    h1 { text-align: center; font-size: 26px; margin-bottom: 10px; color: #1d4e89; }
    h2 { font-size: 18px; margin-top: 30px; color: #2c3e50; }
    p { font-size: 14px; margin-bottom: 6px; color: #555; }
    textarea { width: 100%; height: 60px; font-size: 14px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; resize: vertical; box-sizing: border-box; }
    button { padding: 10px 20px; font-size: 15px; margin-top: 10px; background-color: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
    button:hover { background-color: #2980b9; }
    #log { margin-top: 25px; background: #fdfdfd; border: 1px solid #ccc; padding: 12px; border-radius: 8px; height: 200px; overflow-y: auto; font-size: 13px; white-space: pre-wrap; background-color: #f9fcff; }
  </style>
</head>

<body>
  <div class="container">
    <h1>🧬 PDB Structure & Report Downloader</h1>

    <h2>📦 Download PDB Structural Files (.pdb)</h2>
    <p>Enter PDB IDs (comma-separated, e.g. <code>6LU7,1CBS,2PTC</code>):</p>
    <textarea id="pdbInputStructure" placeholder="Enter PDB IDs..."></textarea><br>
    <button onclick="downloadStructuresZip()">Download Structures</button>

    <h2>📑 Download Validation Reports (.pdf)</h2>
    <p>Enter PDB IDs (comma-separated):</p>
    <textarea id="pdbInputReport" placeholder="Enter PDB IDs..."></textarea><br>
    <button onclick="downloadReportsZip()">Download Reports</button>

    <div id="log"></div>
  </div>

  <script>
    function logMessage(message) {
      const log = document.getElementById('log');
      log.innerText += message + '\n';
      log.scrollTop = log.scrollHeight;
    }

    async function downloadStructuresZip() {
      const input = document.getElementById('pdbInputStructure').value;
      const pdbIds = input.split(',').map(id => id.trim().toUpperCase()).filter(id => id.length === 4);
      document.getElementById('log').innerText = '';
      const zip = new JSZip();

      for (const pdbId of pdbIds) {
        const url = `https://files.rcsb.org/download/${pdbId}.pdb`;
        try {
          const response = await fetch(url);
          if (!response.ok) {
            logMessage(`❌ Failed to fetch ${pdbId}.pdb`);
            continue;
          }
          const content = await response.text();
          zip.file(`${pdbId}.pdb`, content);
          logMessage(`✅ Added: ${pdbId}.pdb`);
        } catch (err) {
          logMessage(`⚠️ Error for ${pdbId}: ${err}`);
        }
      }

      zip.generateAsync({ type: 'blob' }).then(blob => {
        saveAs(blob, 'pdb_structures.zip');
        logMessage(`📦 Downloaded pdb_structures.zip`);
      });
    }

    async function downloadReportsZip() {
      const input = document.getElementById('pdbInputReport').value;
      const pdbIds = input.split(',').map(id => id.trim().toUpperCase()).filter(id => id.length === 4);
      document.getElementById('log').innerText = '';
      const zip = new JSZip();

      for (const pdbId of pdbIds) {
        const prefix = pdbId.substring(1, 3).toLowerCase();
        const lowerId = pdbId.toLowerCase();
        const url = `https://files.rcsb.org/pub/pdb/validation_reports/${prefix}/${lowerId}/${lowerId}_full_validation.pdf`;

        try {
          const response = await fetch(url);
          if (!response.ok) {
            logMessage(`❌ Failed to fetch ${pdbId} report`);
            continue;
          }
          const blob = await response.blob();
          zip.file(`${pdbId}_full_validation.pdf`, blob);
          logMessage(`✅ Added: ${pdbId}_full_validation.pdf`);
        } catch (err) {
          logMessage(`⚠️ Error for ${pdbId}: ${err}`);
        }
      }

      zip.generateAsync({ type: 'blob' }).then(blob => {
        saveAs(blob, 'pdb_reports.zip');
        logMessage(`📦 Downloaded pdb_reports.zip`);
      });
    }
  </script>
</body>
</html>