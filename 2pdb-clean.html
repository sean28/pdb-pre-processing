<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDB Cleaner ‚Äì Retain Protein, Remove Non-target Entities</title>
  <style>
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #eef5f9; margin: 0; padding: 40px 16px; color: #333; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 30px 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    h2 { font-size: 24px; color: #1d4e89; margin-bottom: 12px; text-align: center; }
    .intro { font-size: 14px; color: #555; line-height: 1.6; margin-bottom: 20px; text-align: left; }
    label { font-weight: 600; font-size: 14px; color: #2c3e50; display: block; margin-top: 12px; }
    input[type="file"] { margin-top: 6px; }
    input[type="checkbox"] { margin-right: 6px; }
    button { display: block; padding: 10px 24px; background-color: #3498db; color: white; font-size: 15px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; margin-top: 20px; }
    button:hover { background-color: #2980b9; }
    #chainSelector { margin-top: 10px; }
    #chainOptions label { display: inline-block; margin-right: 14px; margin-top: 6px; font-size: 13.5px; }
    #log { margin-top: 25px; background: #fdfdfd; border: 1px solid #ccc; padding: 14px; border-radius: 8px; font-size: 13px; white-space: pre-wrap; height: 240px; overflow-y: auto; background-color: #f9fcff; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üßπ Step 2: PDB Structure Cleaner</h2>
    <div class="intro">
      ‚Ä¢ Removes common non-target molecules such as solvent (HOH, WAT), ligands, ions, glycerol, HEPES, etc.<br>
      ‚Ä¢ Optional: keep ligands (for complex simulation), cofactors (e.g. NAD/FAD), or metal ions (Zn/Mg)<br>
      ‚Ä¢ Or enable ‚ÄúKeep Protein Chains‚Äù to retain only backbone atoms (ATOM records)
    </div>

    <label for="pdbFile">üìÅ Upload a PDB File</label>
    <input type="file" id="pdbFile" accept=".pdb">

    <label><input type="checkbox" id="keepLigand"> Keep Ligands</label>
    <label><input type="checkbox" id="keepCofactor"> Keep Cofactors (e.g. NAD/FAD)</label>
    <label><input type="checkbox" id="keepMetals"> Keep Metal Ions (ZN/FE/MG/CA)</label>
    <label><input type="checkbox" id="keepchains"> Keep One Protein Chains (Oonly ATOM)</label>

    <div id="chainSelector" style="display: none;">
      <label style="margin-top: 12px;">Select Chains to Keep:</label>
      <div id="chainOptions"></div>
    </div>

    <button onclick="processPDB()">üõ†Ô∏è Clean and Download</button>

    <div id="log">üì• Please select a PDB file to begin cleaning...</div>
  </div>

  <script>
    const metalResidues = ['ZN','FE','MG','CA'];
    const cofactorResidues = ['NAD','FAD','FMN','NAP'];
    const ligandResidues = ['LIG','DRG','INH'];
    const solventResidues = ['HOH','WAT','DOD','SO4','CL','NA','K','HEPES','GOL','IOD','MES','ACN','ACT'];
    const aaResidues = ['ALA','ARG','ASN','ASP','CYS','GLN','GLU','GLY','HIS','ILE','LEU','LYS','MET','PHE','PRO','SER','THR','TRP','TYR','VAL','SEC','PYL','MSE'];

    let globalAllResKeys = new Set();

    function log(msg) {
      const logDiv = document.getElementById('log');
      logDiv.innerText += msg + '\n';
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function shouldRemove(line, options) {
      if (!line.startsWith('ATOM') && !line.startsWith('HETATM')) return false;
      const resname = line.substring(17, 20).trim().toUpperCase();
      const chainID = line.charAt(21).trim();

      if (options.keepChains) {
        if (!aaResidues.includes(resname)) return true;
        if (options.selectedChains.length > 0 && !options.selectedChains.includes(chainID)) return true;
        return false;
      }

      if (solventResidues.includes(resname)) {
        if (options.keepMetals && metalResidues.includes(resname)) return false;
        if (options.keepCofactor && cofactorResidues.includes(resname)) return false;
        if (options.keepLigand && ligandResidues.includes(resname)) return false;
        return true;
      }

      return false;
    }

    function processPDB() {
      const fileInput = document.getElementById('pdbFile');
      const file = fileInput.files[0];
      if (!file) { log("‚ö†Ô∏è Please select a PDB file."); return; }

      const keepOptions = {
        keepLigand: document.getElementById('keepLigand').checked,
        keepCofactor: document.getElementById('keepCofactor').checked,
        keepMetals: document.getElementById('keepMetals').checked,
        keepChains: document.getElementById('keepchains').checked,
        selectedChains: Array.from(document.querySelectorAll('#chainOptions input:checked')).map(cb => cb.value)
      };

      const reader = new FileReader();
      reader.onload = function (e) {
        const lines = e.target.result.split('\n');
        const kept = [], removed = [], atomSerialsToKeep = new Set(), residueSet = new Set(), chainMap = {};

        for (const line of lines) {
          if (!line.startsWith('ATOM') && !line.startsWith('HETATM')) {
            if (line.startsWith('CONECT')) {
              const tokens = line.trim().split(/\s+/).slice(1);
              if (tokens.every(id => atomSerialsToKeep.has(id))) kept.push(line);
            } else if (line.startsWith('TER')) {
              const chainID = line.charAt(21).trim();
              if (chainMap[chainID] && chainMap[chainID].size > 0) kept.push(line);
            } else {
              kept.push(line);
            }
            continue;
          }

          const resname = line.substring(17, 20).trim();
          const chainID = line.charAt(21).trim();
          const resSeq = line.substring(22, 26).trim();
          const resKey = `${chainID}:${resname}-${resSeq}`;

          if (shouldRemove(line, keepOptions)) {
            removed.push(line);
          } else {
            atomSerialsToKeep.add(line.substring(6, 11).trim());
            kept.push(line);
            residueSet.add(resKey);
            if (!chainMap[chainID]) chainMap[chainID] = new Set();
            chainMap[chainID].add(resKey);
          }
        }

        const cleanedText = kept.join('\n');
        const filename = file.name.replace('.pdb', '_cleaned.pdb');
        const blob = new Blob([cleanedText], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        URL.revokeObjectURL(link.href);

        const removedAtoms = removed.length;
        const keptAtoms = kept.filter(l => l.startsWith('ATOM') || l.startsWith('HETATM')).length;
        const removedResidues = [...new Set(removed.map(l => l.substring(17, 20).trim()))];

        log(`‚úÖ Cleaned: ${file.name}`);
        log(`üßπ Removed atom lines: ${removedAtoms}`);
        log(`üßæ Removed residue types: ${removedResidues.join(', ') || 'None'}`);
        log(`üìä Remaining atom lines: ${keptAtoms}`);
        log(`üì¶ Remaining residues: ${residueSet.size}`);
        for (const [chain, set] of Object.entries(chainMap)) {
          log(`  üîó Chain ${chain || '[empty]'}: ${set.size} residues`);
        }
        log(`‚¨áÔ∏è Saved as: ${filename}`);
      };
      reader.readAsText(file);
    }

    document.getElementById('keepchains').addEventListener('change', function () {
      const disabled = this.checked;
      document.getElementById('keepLigand').disabled = disabled;
      document.getElementById('keepCofactor').disabled = disabled;
      document.getElementById('keepMetals').disabled = disabled;
      document.getElementById('chainSelector').style.display = disabled ? 'block' : 'none';
    });

    document.getElementById('pdbFile').addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const lines = e.target.result.split('\n');
        const allChains = new Set();

        for (const line of lines) {
          if (line.startsWith('ATOM') || line.startsWith('HETATM')) {
            const resname = line.substring(17, 20).trim();
            const chainID = line.charAt(21).trim();
            const resSeq = line.substring(22, 26).trim();
            const resKey = `${chainID}:${resname}-${resSeq}`;
            globalAllResKeys.add(resKey);
            allChains.add(chainID);
          }
        }

        const chainSelector = document.getElementById('chainSelector');
        const chainOptionsDiv = document.getElementById('chainOptions');
        chainOptionsDiv.innerHTML = '';
        if (document.getElementById('keepchains').checked) {
          chainSelector.style.display = 'block';
        } else {
          chainSelector.style.display = 'none';
        }

        [...allChains].sort().forEach(chain => {
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = chain;
          checkbox.checked = true;
          checkbox.id = `chain_${chain}`;

          const label = document.createElement('label');
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(` Chain ${chain || '[empty]'}`));
          chainOptionsDiv.appendChild(label);
        });
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>