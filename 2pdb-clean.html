<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDB æ¸…ç†å·¥å…· Â· å»é™¤æ— å…³åˆ†å­</title>
  <style>
    body { font-family: Arial; background: #eef6f9; padding: 20px; }
    h2 { color: #1d4e89; }
    input[type="file"], label { display: block; margin-top: 10px; }
    button { padding: 8px 16px; margin-top: 15px; font-size: 15px; }
    #log { white-space: pre-wrap; margin-top: 20px; background: #fff; padding: 10px; border: 1px solid #ccc; height: 180px; overflow-y: auto; }
  </style>
</head>
<body>

  <h2>ğŸ”¬ ç¬¬2æ­¥ï¼šå»é™¤æ— å…³åˆ†å­</h2>
  <div style="text-align: left; line-height: 1.5; font-size: 16px; margin-top: -10px; margin-bottom: 20px;">
    â€¢ åˆ é™¤ï¼šæº¶å‰‚ã€é…ä½“ã€ç¦»å­ã€ç”˜æ²¹ã€HEPESç­‰éç ”ç©¶ç›®æ ‡åˆ†å­
    <br>
    â€¢ å¯é€‰ä¿ç•™ï¼šé…ä½“ï¼ˆè‹¥åšå¤åˆç‰©æ¨¡æ‹Ÿï¼‰ã€è¾…å› å­ã€é‡‘å±ç­‰
  </div>

  <input type="file" id="pdbFile" accept=".pdb">
  <label><input type="checkbox" id="keepLigand"> ä¿ç•™é…ä½“</label>
  <label><input type="checkbox" id="keepCofactor"> ä¿ç•™è¾…å› å­ï¼ˆå¦‚ NAD/FADï¼‰</label>
  <label><input type="checkbox" id="keepMetals"> ä¿ç•™é‡‘å±ç¦»å­ï¼ˆZN/FE/MG/CAï¼‰</label>
  <label><input type="checkbox" id="keepchains"> ä»…ä¿ç•™æ°¨åŸºé…¸é“¾æ¡ï¼ˆä»…ATOMï¼‰</label>

  <div id="chainSelector" style="margin-top: 0px; display: none;">
    <div id="chainOptions"></div>
  </div>

  <button onclick="processPDB()">å¤„ç†å¹¶ä¸‹è½½</button>
  <div id="log">ğŸ“¥ è¯·é€‰æ‹©ä¸€ä¸ª PDB æ–‡ä»¶è¿›è¡Œå¤„ç†</div>

  <script>
    const metalResidues = ['ZN', 'FE', 'MG', 'CA'];
    const cofactorResidues = ['NAD', 'FAD', 'FMN', 'NAP'];
    const ligandResidues = ['LIG', 'DRG', 'INH'];
    const solventResidues = ['HOH', 'WAT', 'DOD', 'SO4', 'CL', 'NA', 'K', 'HEPES', 'GOL', 'IOD', 'MES', 'ACN', 'ACT'];
    const aaResidues = ['ALA','ARG','ASN','ASP','CYS','GLN','GLU','GLY','HIS','ILE','LEU','LYS','MET','PHE','PRO','SER','THR','TRP','TYR','VAL','SEC','PYL','MSE'];

    let globalAllResKeys = new Set();

    function log(msg) {
      const logDiv = document.getElementById('log');
      logDiv.innerText += msg + '\n';
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function shouldRemove(line, options) {
      if (!line.startsWith('ATOM') && !line.startsWith('HETATM')) return false;
      const resname = line.substring(17, 20).trim().toUpperCase();
      const chainID = line.charAt(21).trim();

      if (options.keepChains) {
        if (!aaResidues.includes(resname)) return true;
        if (options.selectedChains.length > 0 && !options.selectedChains.includes(chainID)) return true;
        return false;
      }

      if (solventResidues.includes(resname)) {
        if (options.keepMetals && metalResidues.includes(resname)) return false;
        if (options.keepCofactor && cofactorResidues.includes(resname)) return false;
        if (options.keepLigand && ligandResidues.includes(resname)) return false;
        return true;
      }

      return false;
    }
    function processPDB() {
      const fileInput = document.getElementById('pdbFile');
      const file = fileInput.files[0];
      if (!file) {
        log("âš ï¸ è¯·å…ˆé€‰æ‹© PDB æ–‡ä»¶");
        return;
      }

      const keepOptions = {
        keepLigand: document.getElementById('keepLigand').checked,
        keepCofactor: document.getElementById('keepCofactor').checked,
        keepMetals: document.getElementById('keepMetals').checked,
        keepChains: document.getElementById('keepchains').checked,
        selectedChains: Array.from(document.querySelectorAll('#chainOptions input:checked')).map(cb => cb.value)
      };

      const reader = new FileReader();
      reader.onload = function (e) {
        const lines = e.target.result.split('\n');
        const kept = [], removed = [];
        const atomSerialsToKeep = new Set(); 
        const residueSet = new Set();
        const chainMap = {};

        for (const line of lines) {
          if (!line.startsWith('ATOM') && !line.startsWith('HETATM')) {
            if (line.startsWith('CONECT')) {
              const tokens = line.trim().split(/\s+/).slice(1);
              const allInSet = tokens.every(id => atomSerialsToKeep.has(id));
              if (allInSet) kept.push(line);
            } else if (line.startsWith('TER')) {
              const chainID = line.charAt(21).trim();
              if (chainMap[chainID] && chainMap[chainID].size > 0) {
                kept.push(line);
              }
            } else {
              kept.push(line);
            }
            continue;
          }

          const resname = line.substring(17, 20).trim();
          const chainID = line.charAt(21).trim();
          const resSeq = line.substring(22, 26).trim();
          const resKey = `${chainID}:${resname}-${resSeq}`;

          if (shouldRemove(line, keepOptions)) {
            removed.push(line);
          } else {
            atomSerialsToKeep.add(line.substring(6, 11).trim());
            kept.push(line);
            residueSet.add(resKey);
            if (!chainMap[chainID]) chainMap[chainID] = new Set();
            chainMap[chainID].add(resKey);
          }
        }

        const cleanedText = kept.join('\n');
        const filename = file.name.replace('.pdb', '_cleaned.pdb');
        const blob = new Blob([cleanedText], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        URL.revokeObjectURL(link.href);

        const removedAtoms = removed.length;
        const keptAtoms = kept.filter(l => l.startsWith('ATOM') || l.startsWith('HETATM')).length;
        const removedResidues = [...new Set(removed.map(l => l.substring(17, 20).trim()))];

        log(`âœ… å¤„ç†å®Œæˆï¼š${file.name}`);
        log(`ğŸ§¹ åˆ é™¤åŸå­è¡Œï¼š${removedAtoms}`);
        log(`ğŸ§¾ åˆ é™¤æ®‹åŸºç±»å‹ï¼š${removedResidues.join(', ') || 'æ— '}`);
        log(`ğŸ“Š ä¿ç•™åŸå­è¡Œæ•°ï¼š${keptAtoms}`);
        log(`ğŸ“¦ ä¿ç•™æ®‹åŸºæ•°ï¼š${residueSet.size}`);
        for (const [chain, set] of Object.entries(chainMap)) {
          log(`  ğŸ”— é“¾ ${chain || '[ç©º]'}ï¼š${set.size} ä¸ªæ®‹åŸº`);
        }
        log(`â¬‡ï¸ ä¸‹è½½æ–‡ä»¶åï¼š${filename}`);
      };
      reader.readAsText(file);
    }

    document.getElementById('keepchains').addEventListener('change', function () {
      const disabled = this.checked;
      document.getElementById('keepLigand').disabled = disabled;
      document.getElementById('keepCofactor').disabled = disabled;
      document.getElementById('keepMetals').disabled = disabled;
      document.getElementById('chainSelector').style.display = disabled ? 'block' : 'none';
    });

    document.getElementById('pdbFile').addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const lines = e.target.result.split('\n');
        const allChains = new Set();

        for (const line of lines) {
          if (line.startsWith('ATOM') || line.startsWith('HETATM')) {
            const resname = line.substring(17, 20).trim();
            const chainID = line.charAt(21).trim();
            const resSeq = line.substring(22, 26).trim();
            const resKey = `${chainID}:${resname}-${resSeq}`;
            globalAllResKeys.add(resKey);
          }
        }

        for (const line of lines) {
          if (line.startsWith('ATOM') || line.startsWith('HETATM')) {
            const chainID = line.charAt(21).trim();
            allChains.add(chainID);
          }
        }

        const chainSelector = document.getElementById('chainSelector');
        const chainOptionsDiv = document.getElementById('chainOptions');
        chainOptionsDiv.innerHTML = '';
        if (document.getElementById('keepchains').checked) {
          chainSelector.style.display = 'block';
        } else {
          chainSelector.style.display = 'none';
        }

        [...allChains].sort().forEach(chain => {
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = chain;
          checkbox.checked = true;
          checkbox.id = `chain_${chain}`;

          const label = document.createElement('label');
          label.style.marginRight = '10px';
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(` é“¾ ${chain || '[ç©º]'}`));
          chainOptionsDiv.appendChild(label);
        });
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>