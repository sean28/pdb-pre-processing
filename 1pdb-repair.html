<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDBFixer åœ¨çº¿ä¿®å¤å·¥å…·</title>
  <style>
    body { font-family: Arial; background: #eef6f9; padding: 20px; }
    input[type="text"], input[type="file"] {
      padding: 6px;
      font-size: 14px;
      width: 400px;
      max-width: 90%;
    }
    button { padding: 8px 16px; margin-top: 10px; font-size: 14px; }
    #log {
      white-space: pre-wrap;
      margin-top: 20px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      height: 180px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

  <h2>ğŸ”§ PDB ç»“æ„ä¿®å¤ï¼ˆåŸºäº PDBFixer å®æ—¶ä¿®å¤ï¼‰</h2>

  <!-- âœ… è‡ªå®šä¹‰æœåŠ¡å™¨åœ°å€ -->
  <div>
    <label>æœåŠ¡å™¨åœ°å€ï¼š</label>
    <input type="text" id="server" value="https://aezvwkinighy.ap-southeast-1.clawcloudrun.com">
  </div>

  <input type="file" id="pdbFile" accept=".pdb">
  <button onclick="uploadAndFix()">ä¸Šä¼ å¹¶ä¿®å¤ç»“æ„</button>

  <div id="log">ğŸ“¥ è¯·ä¸Šä¼  PDB æ–‡ä»¶...</div>

  <script>
    function log(msg) {
      const logDiv = document.getElementById('log');
      logDiv.innerText += msg + '\n';
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function uploadAndFix() {
      const fileInput = document.getElementById('pdbFile');
      const file = fileInput.files[0];
      const server = document.getElementById('server').value.trim().replace(/\/+$/, ''); // å»æ‰å°¾éƒ¨æ–œæ 
      if (!file) {
        log("âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ª PDB æ–‡ä»¶");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      log(`ğŸš€ ä¸Šä¼ ä¸­ï¼š${file.name} åˆ° ${server}/repair`);

      try {
        const response = await fetch(`${server}/repair`, {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          log(`âŒ ä¿®å¤å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
          return;
        }

        const result = await response.json();
        const s = result.summary;

        log(`âœ… ä¿®å¤å®Œæˆï¼`);
        log(`ğŸ§¾ åŸå­æ€»æ•°ï¼š${s.original_atoms} â†’ ${s.repaired_atoms}`);
        log(`â• æ–°å¢åŸå­ï¼š${s.added_atoms}`);
        log(`â• æ–°å¢æ°¢åŸå­ï¼š${s.added_hydrogens}`);
        log(`â• æ–°å¢æ°´åˆ†å­ï¼ˆHOHï¼‰ï¼š${s.added_waters}`);
        log(`â• æ–°å¢é‡‘å±ç¦»å­ï¼š${s.added_metals}`);

        const url = `${server}/download/${result.filename}`;
        const a = document.createElement("a");
        a.href = url;
        a.download = result.filename;
        a.innerText = "â¬‡ï¸ ç‚¹å‡»ä¸‹è½½ä¿®å¤åæ–‡ä»¶";
        document.getElementById("log").appendChild(document.createElement("br"));
        document.getElementById("log").appendChild(a);

      } catch (err) {
        log(`âš ï¸ è¯·æ±‚å¤±è´¥ï¼š${err}`);
      }
    }
  </script>

</body>
</html>
